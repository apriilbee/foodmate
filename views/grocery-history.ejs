<!DOCTYPE html>
<html lang="en">
  <%- include('partials/head') %>
  <link rel="stylesheet" href="/css/grocery-history.css" />
  <body>
    <%- include('partials/navbar') %>
    <div class="container">
      <div class="row">
        <!-- Column 1: Dates -->
        <div class="col s12 m3">
          <h5>Dates:</h5>
          <ul class="gh-list-container">
            <% lists.forEach(item => { %>
              <li 
                class="gh-list-item"
                data-grocery-list-id="<%= item.id %>" 
                data-startdate="<%= item.startDate %>" 
                data-enddate="<%= item.endDate%>">
                <%= item.startDate %> - <%= item.endDate%>
              </li>
            <% }) %>
          </ul>
        </div>

        <!-- Column 2: Grocery List -->
        <div class="col s12 m6">
          <h5>Grocery List</h5>
          <div id="grocery-details">Select a list to view details</div>
        </div>

        <!-- Column 3: Logs -->
        <div class="col s12 m3">
          <h5>Logs</h5>
          <div id="log-details">Activity logs will show here</div>
        </div>
      </div>
    </div>
    <%- include('partials/scripts') %>

    <!-- JS logic to manage active item selection -->
    <script>
      document.querySelectorAll('.gh-list-item').forEach(item => {
        item.addEventListener('click', async () => {
          // Remove active class from all items
          document.querySelectorAll('.gh-list-item').forEach(i => i.classList.remove('active-list'));
          // Add active class to the clicked item
          item.classList.add('active-list');

          // You can also populate grocery list/logs here if needed
          const startDate = item.dataset.startdate;
          const endDate = item.dataset.enddate;
          const id = item.dataset.groceryListId;

          try {
            const token = localStorage.getItem("token");
            const response = await fetch(`/api/groceryList/${id}`, {
              headers: {
                Authorization: `Bearer ${token}`
              }
            })
            if(!response.ok) throw new Error('Failed to fetch grocery list');
            const data = await response.json();

            document.getElementById('grocery-details').innerHTML = 
            `
              <h6>${startDate} - ${endDate}</h6>
              <ul>${generateAisleCards(data.list)}</ul>
            `;
            document.getElementById('log-details').textContent = `Logs for list ID: ${id}`;

          } catch (err) {
            console.error(err);
          }
        });
      });

      function generateAisleCards(groceryList) {
        if (!groceryList || !Array.isArray(groceryList.aisles)) {
          return '<p>No grocery list data available.</p>';
        }
      
        return groceryList.aisles.map(aisle => {
          const itemsHtml = aisle.items.map((item, index) => `
            <div class="row gh-item-row valign-wrapper" data-item-index="${index}">
              <!-- Item + Checkbox -->
              <div class="col s12 m6">
                <label>
                  <input type="checkbox" class="filled-in" />
                  <span>${item.name}</span>
                </label>
              </div>
  
              <div class="col s6 m4">
                ${item.amount} ${item.unit}
              </div>
            
              <div class="col s6 m2">
                <button class="gh-edit-btn" data-item-name="${item.name}">
                  Edit
                </button>
              </div>
            </div>
          `).join('');
          
          return `
            <div class="gh-aisle-card card white" style="margin-bottom: 24px; padding: 16px;">
              <h6 class="orange-text text-darken-3" style="margin-bottom: 12px;">${aisle.aisle}</h6>
              ${itemsHtml}
            </div>
          `;
        }).join('');
      }    </script>
  </body>
</html>